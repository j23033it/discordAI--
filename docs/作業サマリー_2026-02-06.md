# Discord AI通知システム 作業サマリー（2026-02-06）

## 1. 目的
OpenAI / Gemini / Claude Code の公式更新情報を収集し、重複除去と日本語要約を行って Discord に通知する。

## 2. ここまでの実装内容
### 2.1 プロジェクト基盤
- Pythonプロジェクトを作成（`pyproject.toml`）
- 実行CLIを追加
  - `ai-updates-once`
  - `ai-updates-digest`
- 環境変数テンプレートを追加（`.env.example`）

### 2.2 収集・整形・保存
- 収集対象（公式6ソース）を定義（`src/ai_updates/sources.py`）
  - OpenAI ChatGPT Release Notes
  - OpenAI Codex Changelog
  - Gemini API Changelog
  - Gemini CLI GitHub Releases
  - Claude Code Release Notes
  - Claude Code GitHub Releases
- HTML収集とGitHub Releases収集を実装
- 正規化・フィンガープリント生成を実装（重複防止）
- SQLite保存を実装（既読管理、要約保存、即時送信済み、ダイジェスト送信済み）

### 2.3 要約・通知
- 日本語要約処理を実装
  - `OPENAI_API_KEY` がある場合: LLM要約
  - 未設定/失敗時: フォールバック要約
- Discord Webhook通知を実装（サービス別）
- 重要度しきい値で即時通知を制御（`IMMEDIATE_MIN_IMPORTANCE`）

### 2.4 GitHub Actions
- `polling.yml`（30分ごと）
- `digest.yml`（毎日 09:00 JST 相当）
- DB永続化のため、Actions cache restore/save を追加
- 競合回避のため `concurrency` を追加
- ハング防止のため `timeout-minutes: 10` を追加

### 2.5 安定化対応（今回の障害対応）
- 事象: `help.openai.com` が Actions 環境で 403 を返し、ジョブ全体が停止
- 対応: `src/ai_updates/main.py` に例外分離を追加
  - ソース単位で失敗を隔離（1ソース失敗で全停止しない）
  - アイテム単位でも失敗を隔離
  - ダイジェスト送信失敗は警告ログ化して継続

## 3. 現在の状態
- リポジトリ作成済み
- Webhook作成・GitHub Secrets登録済み
- `AI Updates Polling` 実行は成功確認済み（ユーザー報告）
- システムは「一部ソース失敗時でも継続通知」できる状態

## 4. 既知の制約
- 一部HTMLソースはBotアクセス制限（403）を受ける可能性がある
- HTML収集はサイト構造変更に影響を受ける
- `pytest` は実行環境によって未導入の可能性がある（ローカル依存）

## 5. 次のステップ（推奨順）
1. 通知品質の改善
- 即時通知のしきい値を `high` から `medium` に調整検討
- 通知文面に `公開日` と `サービス名` を固定表示
- 日次ダイジェストを重要度順に並び替え

2. 収集信頼性の改善
- 403が出るソースの代替一次ソースを追加
- HTMLソースごとの抽出ルールを明確化

3. 運用保守の追加
- 失敗回数が連続したソースを通知する仕組み
- 将来的に `DB` を外部永続ストレージに移行（必要なら）

## 6. ユーザーが行う作業（必要時のみ）
- Secrets の更新/再発行（Webhook漏洩時）
- Actions 失敗時にログ共有
  - Workflow名
  - 失敗ステップ名
  - エラーログ末尾20〜40行

## 7. 主要ファイル
- `src/ai_updates/main.py`
- `src/ai_updates/sources.py`
- `src/ai_updates/collectors/html_collector.py`
- `src/ai_updates/summarizer.py`
- `src/ai_updates/store.py`
- `.github/workflows/polling.yml`
- `.github/workflows/digest.yml`
